# GitHub Actions workflow to build the site and deploy to GitHub Pages
name: Build and publish Pages

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Ruby (for Jekyll if present)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Build site (auto-detect)
        id: build
        run: |
          set -euo pipefail
          PUBLISH_DIR=""

          if [ -f package.json ]; then
            echo "Detected package.json — running npm build if available"
            npm ci
            if npm run | grep -q "build"; then
              npm run build
            fi
            for d in dist build public; do
              if [ -d "$d" ]; then PUBLISH_DIR="$d"; break; fi
            done

          elif [ -f _config.yml ] || [ -f Gemfile ]; then
            echo "Detected Jekyll — building with Bundler"
            gem install bundler
            bundle install --jobs 4 --retry 3 || true
            bundle exec jekyll build -d _site
            if [ -d _site ]; then PUBLISH_DIR="_site"; fi

          elif [ -f config.toml ] || [ -f config.yaml ] || [ -d content ]; then
            echo "Detected Hugo — installing Hugo and building"
            HUGO_VERSION="0.111.3"
            curl -sL "https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_Linux-64bit.tar.gz" \
              | tar -xz -C /tmp
            sudo mv /tmp/hugo /usr/local/bin/hugo
            hugo
            if [ -d public ]; then PUBLISH_DIR="public"; fi

          else
            echo "No build tool detected; will try common public folders or repo root"
            for d in public dist build; do
              if [ -d "$d" ]; then PUBLISH_DIR="$d"; break; fi
            done
            if [ -z "$PUBLISH_DIR" ]; then
              echo "No build output dir found; using repository root"
              PUBLISH_DIR="."
            fi
          fi

          echo "PUBLISH_DIR=$PUBLISH_DIR" >> "$GITHUB_ENV"
          echo "publish_dir=$PUBLISH_DIR" >> "$GITHUB_OUTPUT"

      - name: Configure Pages
        uses: actions/configure-pages@v3

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v1
        with:
          path: ${{ env.PUBLISH_DIR }}

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v1